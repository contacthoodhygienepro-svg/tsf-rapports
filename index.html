<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>TSF - Rapport Intervention</title>
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2913/2913465.png" />
  <meta name="theme-color" content="#4285f4" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <style>
    @media print {
      .no-print { display: none !important; }
      .print-break-inside-avoid { break-inside: avoid; }
      body { background: white; }
      input, textarea, select {
        border: none !important;
        appearance: none;
        padding: 0;
        background: transparent;
        resize: none;
      }
      ::placeholder { color: transparent; }
    }
    canvas { touch-action: none; }
  </style>
</head>

<body class="bg-gray-100 text-gray-900">
  <div id="root">
    <div class="min-h-screen bg-gray-100 p-4 md:p-8 font-sans">

      <datalist id="list-clients"></datalist>
      <datalist id="list-locations"></datalist>
      <datalist id="list-products"></datalist>

      <div class="max-w-4xl mx-auto mb-6 flex flex-wrap gap-3 items-center justify-between no-print sticky top-0 z-40 bg-white/95 backdrop-blur p-3 shadow-lg rounded-lg">
        <h1 class="text-lg font-bold text-gray-800">TSF Mobile</h1>
        <div class="flex flex-wrap gap-2 text-sm">
          <button onclick="saveDraft()" class="bg-orange-600 text-white px-4 py-2 rounded-lg shadow hover:bg-orange-700 font-medium">üíæ Sauvegarder</button>
          <button onclick="loadDraft()" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 font-medium">üìÇ Charger</button>
          <button onclick="generatePDF()" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 font-bold">üì• T√©l√©charger PDF</button>
        </div>
      </div>

      <div id="report" class="max-w-4xl mx-auto bg-white shadow-xl md:p-10 p-4 print:shadow-none print:p-0">

        <header class="flex flex-col md:flex-row gap-6 border-b-2 border-black pb-4 mb-6">
          <div class="w-full md:w-1/3 flex flex-col items-center justify-center text-center">
            <div class="w-full h-auto border-2 border-black p-2 mb-2 flex items-center justify-center font-bold text-2xl tracking-widest text-gray-800">TSF NORMANDIE</div>
            <p class="text-xs">Impasse des Primev√®res - ZA du Domaine Ducey</p>
            <p class="text-xs font-bold">50220 DUCEY</p>
            <p class="text-xs">Tel. 02 50 26 91 30</p>
            <p class="text-xs">Mail: tsfnormandie@aprolliance.fr</p>
          </div>
          <div class="w-full md:w-2/3 flex flex-col justify-between text-right">
            <p class="text-xs italic text-gray-600 border-b border-gray-300 pb-1">Hygi√®ne de l'air / Hygi√®ne anti-parasitaire / D√©capages</p>
            <h1 class="text-2xl font-black uppercase mt-4 text-center md:text-right">Rapport d'Intervention - D√©ratisation</h1>
          </div>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mb-6">
          <div class="space-y-3">
            <div class="flex flex-col"><label class="font-bold text-sm mb-1">Date interv.:</label><input type="date" id="date" class="border border-gray-400 px-3 py-2 rounded" /></div>
            <div class="flex flex-col"><label class="font-bold text-sm mb-1">Heure:</label><input type="time" id="time" class="border border-gray-400 px-3 py-2 rounded" /></div>
            <div class="flex flex-col"><label class="font-bold text-sm mb-1">Nom applicateur:</label><input type="text" id="applicatorName" class="border border-gray-400 px-3 py-2 rounded" placeholder="Votre nom" /></div>
            <div class="flex flex-col"><label class="font-bold text-sm mb-1">Passage suivant:</label><input type="text" id="nextVisit" placeholder="Date pr√©visionnelle" class="border border-gray-400 px-3 py-2 rounded" /></div>
          </div>

          <div class="space-y-3">
            <div class="flex flex-col"><label class="font-bold text-sm mb-1">Client:</label><input list="list-clients" type="text" id="clientName" class="border border-gray-400 px-3 py-2 rounded" placeholder="Nom / site / adresse" /></div>
            <div class="flex flex-col"><label class="font-bold text-sm mb-1">Email bureau:</label><input type="email" id="emailBureau" class="border border-gray-400 px-3 py-2 rounded" placeholder="contact@email.com" /></div>
            <div class="flex flex-col"><label class="font-bold text-sm mb-1">Email client:</label><input type="email" id="emailClient" class="border border-gray-400 px-3 py-2 rounded" placeholder="client@email.com" /></div>
            <div class="flex flex-col"><label class="font-bold text-sm mb-1">Lieux trait√©s:</label><textarea list="list-locations" rows="2" id="locations" class="border border-gray-400 px-3 py-2 rounded" placeholder="Ex: cuisine, r√©serve, ext√©rieur..."></textarea></div>
          </div>
        </section>

        <section class="bg-gray-50 border border-gray-300 p-3 mb-6">
          <div class="flex flex-col md:flex-row gap-4 justify-between">
            <div class="flex items-center gap-4">
              <span class="font-bold text-sm">Traces de rongeurs :</span>
              <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="traces" value="oui" class="w-5 h-5" /> Oui</label>
              <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="traces" value="non" class="w-5 h-5" /> Non</label>
              <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="traces" value="na" class="w-5 h-5" /> N/A</label>
            </div>
            <div class="flex flex-col gap-1">
              <span class="font-bold text-sm mb-1">Pression :</span>
              <div class="flex gap-4">
                <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="pressure" value="suspicion" /> Suspicion</label>
                <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="pressure" value="effective" /> Traces effectives</label>
                <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="pressure" value="na" /> N/A</label>
              </div>
            </div>
          </div>
        </section>

        <section class="bg-gray-700 text-white p-2 mb-2 font-bold uppercase text-center md:text-left">Type de Traitement Effectu√©</section>
        <div class="flex gap-6 mb-4 px-2">
          <label class="flex items-center gap-2 font-bold cursor-pointer"><input type="radio" name="treatment" value="conventional" checked class="w-5 h-5" />Conventionnel</label>
          <label class="flex items-center gap-2 font-bold cursor-pointer"><input type="radio" name="treatment" value="alternative" class="w-5 h-5" />Alternatif</label>
        </div>

        <div class="mb-4 overflow-x-auto">
          <table class="w-full text-sm border-collapse border border-gray-400">
            <thead>
              <tr class="bg-gray-100">
                <th class="border border-gray-400 p-2 w-24">Moyen</th>
                <th class="border border-gray-400 p-2">Nom produit</th>
                <th class="border border-gray-400 p-2">Mati√®re active</th>
                <th class="border border-gray-400 p-2 w-20">Quantit√©</th>
                <th class="border border-gray-400 p-2 w-24">N¬∞ Postes</th>
                <th class="border border-gray-400 p-2 w-10 no-print"></th>
              </tr>
            </thead>
            <tbody id="chemicalTable"></tbody>
          </table>
          <button onclick="addChemicalRow()" class="mt-2 text-sm bg-blue-600 text-white px-4 py-2 rounded no-print hover:bg-blue-700">+ Ajouter produit</button>
        </div>

        <div class="mb-6 overflow-x-auto">
          <table class="w-full text-sm border-collapse border border-gray-400">
            <thead>
              <tr class="bg-gray-100">
                <th class="border border-gray-400 p-2 w-24">Moyen</th>
                <th class="border border-gray-400 p-2">Type</th>
                <th class="border border-gray-400 p-2 w-20">Quantit√©</th>
                <th class="border border-gray-400 p-2 w-24">N¬∞ Postes</th>
                <th class="border border-gray-400 p-2 w-10 no-print"></th>
              </tr>
            </thead>
            <tbody id="mechanicalTable"></tbody>
          </table>
          <button onclick="addMechanicalRow()" class="mt-2 text-sm bg-blue-600 text-white px-4 py-2 rounded no-print hover:bg-blue-700">+ Ajouter dispositif m√©canique</button>
        </div>

        <section class="mb-6">
          <h3 class="font-bold text-center uppercase mb-2 text-sm bg-gray-200 py-1">Rajout de Postes d'App√¢tage</h3>
          <table class="w-full text-sm border-collapse border border-gray-400 mb-4">
            <thead><tr class="bg-gray-50"><th class="border border-gray-400 p-1 w-20">Type</th><th class="border border-gray-400 p-1">Lieu</th><th class="border border-gray-400 p-1 w-32">Non s√©curis√©s (Qt√©)</th><th class="border border-gray-400 p-1 w-32">S√©curis√©s (Qt√©)</th></tr></thead>
            <tbody>
              <tr><td class="border border-gray-400 p-1 font-bold">Souris</td><td class="border border-gray-400 p-0"><input id="addMiceLieu" class="w-full h-full p-2" /></td><td class="border border-gray-400 p-0"><input id="addMiceNonSec" class="w-full h-full p-2 text-center" type="number" /></td><td class="border border-gray-400 p-0"><input id="addMiceSec" class="w-full h-full p-2 text-center" type="number" /></td></tr>
              <tr><td class="border border-gray-400 p-1 font-bold">Rats</td><td class="border border-gray-400 p-0"><input id="addRatsLieu" class="w-full h-full p-2" /></td><td class="border border-gray-400 p-0"><input id="addRatsNonSec" class="w-full h-full p-2 text-center" type="number" /></td><td class="border border-gray-400 p-0"><input id="addRatsSec" class="w-full h-full p-2 text-center" type="number" /></td></tr>
            </tbody>
          </table>

          <h3 class="font-bold text-center uppercase mb-2 text-sm bg-gray-200 py-1">Remplacement de Postes d'App√¢tage</h3>
          <table class="w-full text-sm border-collapse border border-gray-400">
            <thead><tr class="bg-gray-50"><th class="border border-gray-400 p-1 w-20">Type</th><th class="border border-gray-400 p-1">Lieu</th><th class="border border-gray-400 p-1 w-32">Non s√©curis√©s (Qt√©)</th><th class="border border-gray-400 p-1 w-32">S√©curis√©s (Qt√©)</th></tr></thead>
            <tbody>
              <tr><td class="border border-gray-400 p-1 font-bold">Souris</td><td class="border border-gray-400 p-0"><input id="replMiceLieu" class="w-full h-full p-2" /></td><td class="border border-gray-400 p-0"><input id="replMiceNonSec" class="w-full h-full p-2 text-center" type="number" /></td><td class="border border-gray-400 p-0"><input id="replMiceSec" class="w-full h-full p-2 text-center" type="number" /></td></tr>
              <tr><td class="border border-gray-400 p-1 font-bold">Rats</td><td class="border border-gray-400 p-0"><input id="replRatsLieu" class="w-full h-full p-2" /></td><td class="border border-gray-400 p-0"><input id="replRatsNonSec" class="w-full h-full p-2 text-center" type="number" /></td><td class="border border-gray-400 p-0"><input id="replRatsSec" class="w-full h-full p-2 text-center" type="number" /></td></tr>
            </tbody>
          </table>

          <div class="flex gap-4 mt-3 text-sm">
            <label class="flex items-center gap-2"><input type="checkbox" id="techSheets" class="w-5 h-5" />Fiches techniques fournies</label>
            <label class="flex items-center gap-2"><input type="checkbox" id="safetySheets" class="w-5 h-5" />FDS fournies</label>
          </div>
        </section>

        <div class="print-break-inside-avoid">
          <section class="bg-gray-700 text-white p-2 mb-2 font-bold uppercase text-center md:text-left">Actions Correctives / Pr√©ventives Recommand√©es</section>
          <textarea rows="6" id="correctiveActions" spellcheck="true" class="w-full border border-gray-400 p-3 mb-6 text-base" placeholder="D√©crivez les actions recommand√©es..."></textarea>

          <section class="bg-gray-700 text-white p-2 mb-2 font-bold uppercase text-center md:text-left">Avanc√©es des Recommandations Ant√©rieures</section>
          <textarea rows="5" id="previousRecommendations" spellcheck="true" class="w-full border border-gray-400 p-3 mb-6 text-base" placeholder="√âtat d'avancement des recommandations pr√©c√©dentes..."></textarea>

          <section class="mb-6 print-break-inside-avoid">
            <div class="bg-gray-700 text-white p-2 mb-2 font-bold uppercase flex justify-between items-center">
              <span>Photos de l'intervention</span>
              <label class="bg-white text-gray-800 text-sm px-3 py-1 rounded cursor-pointer hover:bg-gray-200 no-print">üì∑ Ajouter Photo<input type="file" accept="image/*" capture="environment" multiple class="hidden" onchange="handlePhotoUpload(event)" /></label>
            </div>
            <div id="photosContainer" class="grid grid-cols-2 md:grid-cols-3 gap-4 border p-2 border-gray-200 min-h-[100px]">
              <div class="col-span-full text-center text-gray-500 italic" id="noPhotos">Aucune photo ajout√©e.</div>
            </div>
          </section>

          <section class="mb-4">
            <p class="text-xs text-justify mb-4">Le client reconna√Æt que les travaux ont √©t√© r√©alis√©s conform√©ment au bon de commande. IMPORTANT : Les produits utilis√©s sont des produits dangereux. Le client s'engage √† respecter les consignes et d√©lais d'attente.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div class="border border-gray-300 rounded p-4 bg-white">
                <label class="block text-sm font-bold mb-2 text-gray-700 uppercase">Signature Applicateur</label>
                <div class="border-2 border-dashed border-gray-300 rounded relative">
                  <canvas id="sigApplicator" width="400" height="150" class="w-full h-32 touch-none cursor-crosshair"></canvas>
                  <div id="placeholderApp" class="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-400 text-sm">Signer ici</div>
                </div>
                <div class="mt-2 flex justify-end no-print"><button type="button" onclick="clearSignature('sigApplicator', 'placeholderApp')" class="text-xs text-red-600 hover:text-red-800 underline">Effacer</button></div>
              </div>

              <div class="border border-gray-300 rounded p-4 bg-white">
                <label class="block text-sm font-bold mb-2 text-gray-700 uppercase">Signature Client</label>
                <div class="border-2 border-dashed border-gray-300 rounded relative">
                  <canvas id="sigClient" width="400" height="150" class="w-full h-32 touch-none cursor-crosshair"></canvas>
                  <div id="placeholderClient" class="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-400 text-sm">Signer ici</div>
                </div>
                <div class="mt-2 flex justify-end no-print"><button type="button" onclick="clearSignature('sigClient', 'placeholderClient')" class="text-xs text-red-600 hover:text-red-800 underline">Effacer</button></div>
              </div>
            </div>
            <p class="text-xs text-gray-500 italic mt-3 no-print">Astuce : apr√®s signature, appuie sur "Sauver" pour √™tre s√ªr que tout reste dans le brouillon.</p>
          </section>
        </div>

        <div class="text-center text-xs text-gray-500 mt-8 border-t pt-2 no-print">TSF NORMANDIE - Digital Report Mobile (v4)</div>
        <div class="text-right text-[10px] text-gray-400 hidden print:block mt-8">Membre du r√©seau APROLLIANCE</div>
      </div>
    </div>
  </div><script>
    let chemicalRows = [];
    let mechanicalRows = [];
    let photos = [];
    let memories = { clients: [], locations: [], products: [] };

    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('time').value = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

    try {
      const saved = localStorage.getItem('tsf_memories');
      if (saved) memories = JSON.parse(saved);
      updateDatalist('list-clients', memories.clients);
      updateDatalist('list-locations', memories.locations);
      updateDatalist('list-products', memories.products);
    } catch(e) {}

    function updateDatalist(id, items) {
      const dl = document.getElementById(id);
      dl.innerHTML = items.map(i => `<option value="${i}"></option>`).join('');
    }

    function saveToMemory() {
      const client = document.getElementById('clientName').value;
      const location = document.getElementById('locations').value;
      
      if (client && !memories.clients.includes(client)) {
        memories.clients.push(client);
        memories.clients.sort();
      }
      if (location && !memories.locations.includes(location)) {
        memories.locations.push(location);
        memories.locations.sort();
      }
      
      chemicalRows.forEach(r => {
        const prod = r.productName;
        if (prod && !memories.products.includes(prod)) {
          memories.products.push(prod);
          memories.products.sort();
        }
      });

      try {
        localStorage.setItem('tsf_memories', JSON.stringify(memories));
        updateDatalist('list-clients', memories.clients);
        updateDatalist('list-locations', memories.locations);
        updateDatalist('list-products', memories.products);
      } catch(e) {}
    }

    function addChemicalRow() {
      const id = Date.now();
      chemicalRows.push({ id, isToxic: true, productName: '', activeMaterial: '', quantity: '', stationNumber: '' });
      renderChemicalTable();
    }

    function removeChemicalRow(id) {
      chemicalRows = chemicalRows.filter(r => r.id !== id);
      renderChemicalTable();
    }

    function renderChemicalTable() {
      const tbody = document.getElementById('chemicalTable');
      tbody.innerHTML = chemicalRows.map(row => `
        <tr>
          <td class="border border-gray-400 p-2">
            <select onchange="updateChemicalRow(${row.id}, 'isToxic', this.value === 'Toxique')" class="w-full bg-transparent">
              <option ${row.isToxic ? 'selected' : ''}>Toxique</option>
              <option ${!row.isToxic ? 'selected' : ''}>Placebo</option>
            </select>
          </td>
          <td class="border border-gray-400 p-1">
            <input list="list-products" class="w-full p-1" value="${row.productName}" oninput="updateChemicalRow(${row.id}, 'productName', this.value)" />
          </td>
          <td class="border border-gray-400 p-1">
            <input class="w-full p-1" value="${row.activeMaterial}" oninput="updateChemicalRow(${row.id}, 'activeMaterial', this.value)" />
          </td>
          <td class="border border-gray-400 p-1">
            <input class="w-full p-1" value="${row.quantity}" oninput="updateChemicalRow(${row.id}, 'quantity', this.value)" />
          </td>
          <td class="border border-gray-400 p-1">
            <input class="w-full p-1" value="${row.stationNumber}" oninput="updateChemicalRow(${row.id}, 'stationNumber', this.value)" />
          </td>
          <td class="border border-gray-400 p-1 text-center no-print">
            <button onclick="removeChemicalRow(${row.id})" class="text-red-500 font-bold text-xl">√ó</button>
          </td>
        </tr>
      `).join('');
    }

    function updateChemicalRow(id, field, value) {
      const row = chemicalRows.find(r => r.id === id);
      if (row) row[field] = value;
    }

    function addMechanicalRow() {
      const id = Date.now();
      mechanicalRows.push({ id, type: 'Tapette', quantity: '', stationNumber: '' });
      renderMechanicalTable();
    }

    function removeMechanicalRow(id) {
      mechanicalRows = mechanicalRows.filter(r => r.id !== id);
      renderMechanicalTable();
    }

    function renderMechanicalTable() {
      const tbody = document.getElementById('mechanicalTable');
      tbody.innerHTML = mechanicalRows.map(row => `
        <tr>
          <td class="border border-gray-400 p-2 text-center bg-gray-50">M√©canique</td>
          <td class="border border-gray-400 p-1">
            <select onchange="updateMechanicalRow(${row.id}, 'type', this.value)" class="w-full bg-transparent">
              <option ${row.type === 'Tapette' ? 'selected' : ''}>Tapette</option>
              <option ${row.type === 'Plaque de Glue' ? 'selected' : ''}>Plaque de Glue</option>
              <option ${row.type === 'Autres' ? 'selected' : ''}>Autres</option>
            </select>
          </td>
          <td class="border border-gray-400 p-1">
            <input class="w-full p-1" value="${row.quantity}" oninput="updateMechanicalRow(${row.id}, 'quantity', this.value)" />
          </td>
          <td class="border border-gray-400 p-1">
            <input class="w-full p-1" value="${row.stationNumber}" oninput="updateMechanicalRow(${row.id}, 'stationNumber', this.value)" />
          </td>
          <td class="border border-gray-400 p-1 text-center no-print">
            <button onclick="removeMechanicalRow(${row.id})" class="text-red-500 font-bold text-xl">√ó</button>
          </td>
        </tr>
      `).join('');
    }

    function updateMechanicalRow(id, field, value) {
      const row = mechanicalRows.find(r => r.id === id);
      if (row) row[field] = value;
    }

    function handlePhotoUpload(e) {
      if (!e.target.files) return;
      Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onloadend = () => {
          photos.push(reader.result);
          renderPhotos();
        };
        reader.readAsDataURL(file);
      });
    }

    function removePhoto(index) {
      photos.splice(index, 1);
      renderPhotos();
    }

    function renderPhotos() {
      const container = document.getElementById('photosContainer');
      const noPhotos = document.getElementById('noPhotos');
      
      if (photos.length === 0) {
        noPhotos.style.display = 'block';
      } else {
        noPhotos.style.display = 'none';
        container.innerHTML = photos.map((photo, i) => `
          <div class="relative group border border-gray-300 p-1 bg-white">
            <img src="${photo}" class="w-full h-32 object-cover" />
            <button onclick="removePhoto(${i})" class="absolute top-0 right-0 bg-red-600 text-white w-8 h-8 flex items-center justify-center rounded-bl opacity-70 hover:opacity-100 no-print text-xl">√ó</button>
          </div>
        `).join('') + '<div class="col-span-full text-center text-gray-500 italic hidden" id="noPhotos">Aucune photo ajout√©e.</div>';
      }
    }

    function initSignature(canvasId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      let isDrawing = false;

      const getCoords = (e) => {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
      };

      const startDrawing = (e) => {
        e.preventDefault();
        isDrawing = true;
        const placeholder = canvasId === 'sigApplicator' ? 'placeholderApp' : 'placeholderClient';
        document.getElementById(placeholder).style.display = 'none';
        const coords = getCoords(e);
        ctx.beginPath();
        ctx.moveTo(coords.x, coords.y);
      };

      const draw = (e) => {
        if (!isDrawing) return;
        e.preventDefault();
        const coords = getCoords(e);
        ctx.lineTo(coords.x, coords.y);
        ctx.stroke();
      };

      const stopDrawing = () => { isDrawing = false; };

      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseleave', stopDrawing);
      canvas.addEventListener('touchstart', startDrawing);
      canvas.addEventListener('touchmove', draw);
      canvas.addEventListener('touchend', stopDrawing);
    }

    function clearSignature(canvasId, placeholderId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById(placeholderId).style.display = 'flex';
    }

    initSignature('sigApplicator');
    initSignature('sigClient');

    function saveDraft() {
      const data = {
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        applicatorName: document.getElementById('applicatorName').value,
        clientName: document.getElementById('clientName').value,
        emailBureau: document.getElementById('emailBureau').value,
        emailClient: document.getElementById('emailClient').value,
        nextVisit: document.getElementById('nextVisit').value,
        locations: document.getElementById('locations').value,
        traces: document.querySelector('input[name="traces"]:checked')?.value,
        pressure: document.querySelector('input[name="pressure"]:checked')?.value,
        treatment: document.querySelector('input[name="treatment"]:checked')?.value,
        chemicalRows, mechanicalRows,
        addMiceLieu: document.getElementById('addMiceLieu').value,
        addMiceNonSec: document.getElementById('addMiceNonSec').value,
        addMiceSec: document.getElementById('addMiceSec').value,
        addRatsLieu: document.getElementById('addRatsLieu').value,
        addRatsNonSec: document.getElementById('addRatsNonSec').value,
        addRatsSec: document.getElementById('addRatsSec').value,
        replMiceLieu: document.getElementById('replMiceLieu').value,
        replMiceNonSec: document.getElementById('replMiceNonSec').value,
        replMiceSec: document.getElementById('replMiceSec').value,
        replRatsLieu: document.getElementById('replRatsLieu').value,
        replRatsNonSec: document.getElementById('replRatsNonSec').value,
        replRatsSec: document.getElementById('replRatsSec').value,
        techSheets: document.getElementById('techSheets').checked,
        safetySheets: document.getElementById('safetySheets').checked,
        correctiveActions: document.getElementById('correctiveActions').value,
        previousRecommendations: document.getElementById('previousRecommendations').value,
        sigApplicator: document.getElementById('sigApplicator').toDataURL(),
        sigClient: document.getElementById('sigClient').toDataURL()
      };
      
      try {
        localStorage.setItem('tsf_draft', JSON.stringify(data));
        saveToMemory();
        alert('‚úÖ Brouillon sauvegard√© !');
      } catch(e) { alert('‚ö†Ô∏è Impossible de sauvegarder'); }
    }

    function loadDraft() {
      try {
        const saved = localStorage.getItem('tsf_draft');
        if (!saved) { alert('Aucun brouillon trouv√©.'); return; }
        if (!confirm('Charger le dernier brouillon ?')) return;
        
        const data = JSON.parse(saved);
        
        document.getElementById('date').value = data.date || '';
        document.getElementById('time').value = data.time || '';
        document.getElementById('applicatorName').value = data.applicatorName || '';
        document.getElementById('clientName').value = data.clientName || '';
        document.getElementById('emailBureau').value = data.emailBureau || '';
        document.getElementById('emailClient').value = data.emailClient || '';
        document.getElementById('nextVisit').value = data.nextVisit || '';
        document.getElementById('locations').value = data.locations || '';
        
        if (data.traces) {
          const radio = document.querySelector(`input[name="traces"][value="${data.traces}"]`);
          if (radio) radio.checked = true;
        }
        if (data.pressure) {
          const radio = document.querySelector(`input[name="pressure"][value="${data.pressure}"]`);
          if (radio) radio.checked = true;
        }
        if (data.treatment) {
          const radio = document.querySelector(`input[name="treatment"][value="${data.treatment}"]`);
          if (radio) radio.checked = true;
        }
        
        chemicalRows = data.chemicalRows || [];
        mechanicalRows = data.mechanicalRows || [];
        renderChemicalTable();
        renderMechanicalTable();
        
        document.getElementById('addMiceLieu').value = data.addMiceLieu || '';
        document.getElementById('addMiceNonSec').value = data.addMiceNonSec || '';
        document.getElementById('addMiceSec').value = data.addMiceSec || '';
        document.getElementById('addRatsLieu').value = data.addRatsLieu || '';
        document.getElementById('addRatsNonSec').value = data.addRatsNonSec || '';
        document.getElementById('addRatsSec').value = data.addRatsSec || '';
        document.getElementById('replMiceLieu').value = data.replMiceLieu || '';
        document.getElementById('replMiceNonSec').value = data.replMiceNonSec || '';
        document.getElementById('replMiceSec').value = data.replMiceSec || '';
        document.getElementById('replRatsLieu').value = data.replRatsLieu || '';
        document.getElementById('replRatsNonSec').value = data.replRatsNonSec || '';
        document.getElementById('replRatsSec').value = data.replRatsSec || '';
        
        document.getElementById('techSheets').checked = data.techSheets || false;
        document.getElementById('safetySheets').checked = data.safetySheets || false;
        
        document.getElementById('correctiveActions').value = data.correctiveActions || '';
        document.getElementById('previousRecommendations').value = data.previousRecommendations || '';
        
        if (data.sigApplicator) {
          const canvas = document.getElementById('sigApplicator');
          const ctx = canvas.getContext('2d');
          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, 0, 0);
            document.getElementById('placeholderApp').style.display = 'none';
          };
          img.src = data.sigApplicator;
        }
        
        if (data.sigClient) {
          const canvas = document.getElementById('sigClient');
          const ctx = canvas.getContext('2d');
          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, 0, 0);
            document.getElementById('placeholderClient').style.display = 'none';
          };
          img.src = data.sigClient;
        }
        
        alert('‚úÖ Brouillon charg√© !');
      } catch(e) { alert('‚ùå Erreur lors du chargement'); }
    }

    async function generatePDF() {
      const client = document.getElementById('clientName').value;
      if (!client) { alert('‚ö†Ô∏è Veuillez renseigner le nom du client'); return; }

      try {
        saveToMemory();
        
        const element = document.getElementById('report').cloneNode(true);
        const sigApp = document.getElementById('sigApplicator');
        const sigCli = document.getElementById('sigClient');
        
        const canvases = element.querySelectorAll('canvas');
        if (canvases[0]) canvases[0].outerHTML = `<img src="${sigApp.toDataURL()}" style="max-width:100%; height:auto;"/>`;
        if (canvases[1]) canvases[1].outerHTML = `<img src="${sigCli.toDataURL()}" style="max-width:100%; height:auto;"/>`;

        const date = document.getElementById('date').value.split('-').reverse().join('-');
        const filename = `TSF_${client.replace(/[^a-zA-Z0-9]/g, '_')}_${date}.pdf`;

        const worker = html2pdf().set({
          margin: 8,
          filename,
          image: { type: 'jpeg', quality: 0.95 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).from(element);

        await worker.save();
        alert('‚úÖ PDF t√©l√©charg√© ! Fichier : ' + filename);
        
        if (confirm('Voulez-vous r√©initialiser le formulaire ?')) resetForm();
      } catch (error) {
        console.error('PDF error:', error);
        alert('‚ùå Erreur g√©n√©ration PDF');
      }
    }

    function resetForm() {
      document.getElementById('date').valueAsDate = new Date();
      document.getElementById('time').value = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      document.getElementById('applicatorName').value = '';
      document.getElementById('clientName').value = '';
      document.getElementById('emailBureau').value = '';
      document.getElementById('emailClient').value = '';
      document.getElementById('nextVisit').value = '';
      document.getElementById('locations').value = '';
      document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
      document.querySelector('input[name="treatment"][value="conventional"]').checked = true;
      chemicalRows = [];
      mechanicalRows = [];
      renderChemicalTable();
      renderMechanicalTable();
      document.getElementById('addMiceLieu').value = '';
      document.getElementById('addMiceNonSec').value = '';
      document.getElementById('addMiceSec').value = '';
      document.getElementById('addRatsLieu').value = '';
      document.getElementById('addRatsNonSec').value = '';
      document.getElementById('addRatsSec').value = '';
      document.getElementById('replMiceLieu').value = '';
      document.getElementById('replMiceNonSec').value = '';
      document.getElementById('replMiceSec').value = '';
      document.getElementById('replRatsLieu').value = '';
      document.getElementById('replRatsNonSec').value = '';
      document.getElementById('replRatsSec').value = '';
      document.getElementById('techSheets').checked = false;
      document.getElementById('safetySheets').checked = false;
      document.getElementById('correctiveActions').value = '';
      document.getElementById('previousRecommendations').value = '';
      photos = [];
      renderPhotos();
      clearSignature('sigApplicator', 'placeholderApp');
      clearSignature('sigClient', 'placeholderClient');
      alert('‚úÖ Formulaire r√©initialis√© !');
    }
  </script>
</body>
</html>
