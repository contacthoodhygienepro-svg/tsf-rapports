<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>TSF - Rapport Intervention</title>
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2913/2913465.png" />
  <meta name="theme-color" content="#4285f4" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <style>
    @media print {
      .no-print { display: none !important; }
      body { background: white; }
      input, textarea, select { border: none !important; appearance: none; padding: 0; background: transparent; resize: none; }
      ::placeholder { color: transparent; }
    }
    canvas { touch-action: none; }
    @page { margin: 10mm; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div id="root">
    <datalist id="list-clients"></datalist>
    <datalist id="list-locations"></datalist>
    <datalist id="list-products"></datalist>

    <div class="max-w-5xl mx-auto mb-4 flex flex-wrap gap-2 items-center justify-between no-print sticky top-0 z-50 bg-white/95 backdrop-blur p-3 shadow-lg rounded-lg">
      <h1 class="text-lg font-bold text-gray-800">TSF Mobile</h1>
      <div class="flex flex-wrap gap-2 text-sm">
        <button onclick="saveDraft()" class="bg-orange-600 text-white px-3 py-2 rounded shadow hover:bg-orange-700">üíæ Sauvegarder</button>
        <button onclick="loadDraft()" class="bg-blue-600 text-white px-3 py-2 rounded shadow hover:bg-blue-700">üìÇ Charger</button>
        <button onclick="resetForm()" class="bg-purple-600 text-white px-3 py-2 rounded shadow hover:bg-purple-700">üîÑ Nouveau</button>
        <button onclick="generatePDF()" class="bg-green-600 text-white px-3 py-2 rounded shadow hover:bg-green-700 font-bold">üì• PDF</button>
      </div>
    </div>

    <div id="report" class="max-w-5xl mx-auto bg-white shadow-xl p-6 print:shadow-none print:p-0">
      
      <header class="flex gap-4 border-b-2 border-black pb-3 mb-4">
        <div class="w-1/3 text-center">
          <div class="border-2 border-black p-2 mb-1 font-bold text-xl">TSF NORMANDIE</div>
          <p class="text-[10px]">Impasse des Primev√®res - ZA du Domaine Ducey</p>
          <p class="text-[10px] font-bold">50220 DUCEY</p>
          <p class="text-[10px]">Tel. 02 50 26 91 30</p>
          <p class="text-[10px]">Mail: tsfnormandie@aprolliance.fr</p>
        </div>
        <div class="w-2/3 text-right">
          <p class="text-[10px] italic border-b pb-1">Hygi√®ne de l'air / Hygi√®ne anti-parasitaire / D√©capages</p>
          <h1 class="text-xl font-black uppercase mt-2">Rapport d'Intervention - D√©ratisation</h1>
        </div>
      </header>

      <section class="grid grid-cols-2 gap-4 mb-4 text-xs">
        <div class="space-y-2">
          <div><label class="font-bold">Date interv.:</label><input type="date" id="date" class="border-b border-gray-400 w-full px-1" /></div>
          <div><label class="font-bold">Heure:</label><input type="time" id="time" class="border-b border-gray-400 w-full px-1" /></div>
          <div><label class="font-bold">Nom applicateur:</label><input type="text" id="applicatorName" class="border-b border-gray-400 w-full px-1" /></div>
          <div><label class="font-bold">Passage suivant:</label><input type="text" id="nextVisit" class="border-b border-gray-400 w-full px-1" /></div>
        </div>
        <div class="space-y-2">
          <div><label class="font-bold">Nom client:</label><input list="list-clients" type="text" id="clientNom" class="border-b border-gray-400 w-full px-1" /></div>
          <div><label class="font-bold">Pr√©nom client:</label><input type="text" id="clientPrenom" class="border-b border-gray-400 w-full px-1" /></div>
          <div><label class="font-bold">Adresse:</label><input type="text" id="clientAdresse" class="border-b border-gray-400 w-full px-1" /></div>
          <div class="grid grid-cols-2 gap-2">
            <div><label class="font-bold">Code postal:</label><input type="text" id="clientCP" class="border-b border-gray-400 w-full px-1" /></div>
            <div><label class="font-bold">Ville:</label><input type="text" id="clientVille" class="border-b border-gray-400 w-full px-1" /></div>
          </div>
        </div>
      </section>

      <section class="grid grid-cols-2 gap-4 mb-4 text-xs">
        <div><label class="font-bold">Email bureau:</label><input type="email" id="emailBureau" class="border-b border-gray-400 w-full px-1" /></div>
        <div><label class="font-bold">Email client:</label><input type="email" id="emailClient" class="border-b border-gray-400 w-full px-1" /></div>
      </section>

      <section class="mb-4 text-xs">
        <label class="font-bold">Lieux trait√©s:</label>
        <textarea list="list-locations" rows="1" id="locations" class="border-b border-gray-400 w-full px-1"></textarea>
      </section>

      <section class="bg-gray-100 border p-2 mb-3 text-xs grid grid-cols-2 gap-2">
        <div>
          <span class="font-bold">Traces de rongeurs :</span>
          <label class="ml-2"><input type="radio" name="traces" value="oui" /> Oui</label>
          <label class="ml-2"><input type="radio" name="traces" value="non" /> Non</label>
          <label class="ml-2"><input type="radio" name="traces" value="na" /> N/A</label>
        </div>
        <div>
          <span class="font-bold">Pression :</span>
          <label class="ml-2"><input type="radio" name="pressure" value="suspicion" /> Suspicion</label>
          <label class="ml-2"><input type="radio" name="pressure" value="effective" /> Traces effectives</label>
          <label class="ml-2"><input type="radio" name="pressure" value="na" /> N/A</label>
        </div>
      </section>

      <section class="bg-gray-700 text-white p-1 mb-2 text-xs font-bold uppercase">Type de Traitement Effectu√©</section>
      <div class="mb-3 text-xs">
        <label class="mr-4"><input type="radio" name="treatment" value="conventional" checked /> Conventionnel</label>
        <label><input type="radio" name="treatment" value="alternative" /> Alternatif</label>
      </div>

      <div class="mb-3">
        <table class="w-full text-[10px] border-collapse border border-gray-400">
          <thead><tr class="bg-gray-100"><th class="border p-1">Moyen</th><th class="border p-1">Nom produit</th><th class="border p-1">Mati√®re active</th><th class="border p-1">Qt√©</th><th class="border p-1">N¬∞ Postes</th><th class="border p-1 no-print"></th></tr></thead>
          <tbody id="chemicalTable"></tbody>
        </table>
        <button onclick="addChemicalRow()" class="mt-1 text-[10px] bg-blue-600 text-white px-2 py-1 rounded no-print">+ Ajouter produit</button>
      </div>

      <div class="mb-3">
        <table class="w-full text-[10px] border-collapse border border-gray-400">
          <thead><tr class="bg-gray-100"><th class="border p-1">Moyen</th><th class="border p-1">Type</th><th class="border p-1">Qt√©</th><th class="border p-1">N¬∞ Postes</th><th class="border p-1 no-print"></th></tr></thead>
          <tbody id="mechanicalTable"></tbody>
        </table>
        <button onclick="addMechanicalRow()" class="mt-1 text-[10px] bg-blue-600 text-white px-2 py-1 rounded no-print">+ Ajouter dispositif</button>
      </div>

      <section class="mb-3">
        <h3 class="text-[10px] font-bold bg-gray-200 p-1 text-center">Rajout de Postes d'App√¢tage</h3>
        <table class="w-full text-[10px] border border-gray-400 mb-2">
          <thead><tr class="bg-gray-50"><th class="border p-1">Type</th><th class="border p-1">Lieu</th><th class="border p-1">Non s√©c. (Qt√©)</th><th class="border p-1">S√©c. (Qt√©)</th></tr></thead>
          <tbody>
            <tr><td class="border p-1 font-bold">Souris</td><td class="border p-0"><input id="addMiceLieu" class="w-full p-1" /></td><td class="border p-0"><input id="addMiceNonSec" type="number" class="w-full p-1 text-center" /></td><td class="border p-0"><input id="addMiceSec" type="number" class="w-full p-1 text-center" /></td></tr>
            <tr><td class="border p-1 font-bold">Rats</td><td class="border p-0"><input id="addRatsLieu" class="w-full p-1" /></td><td class="border p-0"><input id="addRatsNonSec" type="number" class="w-full p-1 text-center" /></td><td class="border p-0"><input id="addRatsSec" type="number" class="w-full p-1 text-center" /></td></tr>
          </tbody>
        </table>

        <h3 class="text-[10px] font-bold bg-gray-200 p-1 text-center">Remplacement de Postes d'App√¢tage</h3>
        <table class="w-full text-[10px] border border-gray-400">
          <thead><tr class="bg-gray-50"><th class="border p-1">Type</th><th class="border p-1">Lieu</th><th class="border p-1">Non s√©c. (Qt√©)</th><th class="border p-1">S√©c. (Qt√©)</th></tr></thead>
          <tbody>
            <tr><td class="border p-1 font-bold">Souris</td><td class="border p-0"><input id="replMiceLieu" class="w-full p-1" /></td><td class="border p-0"><input id="replMiceNonSec" type="number" class="w-full p-1 text-center" /></td><td class="border p-0"><input id="replMiceSec" type="number" class="w-full p-1 text-center" /></td></tr>
            <tr><td class="border p-1 font-bold">Rats</td><td class="border p-0"><input id="replRatsLieu" class="w-full p-1" /></td><td class="border p-0"><input id="replRatsNonSec" type="number" class="w-full p-1 text-center" /></td><td class="border p-0"><input id="replRatsSec" type="number" class="w-full p-1 text-center" /></td></tr>
          </tbody>
        </table>
        <div class="mt-2 text-[10px] space-x-3">
          <label><input type="checkbox" id="techSheets" /> Fiches techniques fournies</label>
          <label><input type="checkbox" id="safetySheets" /> FDS fournies</label>
        </div>
      </section>

      <section class="mb-3">
        <div class="bg-gray-700 text-white p-1 text-[10px] font-bold uppercase">Actions Correctives / Pr√©ventives Recommand√©es</div>
        <textarea rows="3" id="correctiveActions" spellcheck="true" class="w-full border p-1 text-[10px]"></textarea>
      </section>

      <section class="mb-3">
        <div class="bg-gray-700 text-white p-1 text-[10px] font-bold uppercase">Avanc√©es des Recommandations Ant√©rieures</div>
        <textarea rows="2" id="previousRecommendations" spellcheck="true" class="w-full border p-1 text-[10px]"></textarea>
      </section>

      <section class="mb-3">
        <div class="bg-gray-700 text-white p-1 text-[10px] font-bold uppercase flex justify-between items-center">
          <span>Photos de l'intervention</span>
          <label class="bg-white text-gray-800 px-2 py-1 rounded cursor-pointer hover:bg-gray-200 no-print">üì∑ Ajouter<input type="file" accept="image/*" capture="environment" multiple class="hidden" onchange="handlePhotoUpload(event)" /></label>
        </div>
        <div id="photosContainer" class="grid grid-cols-4 gap-2 border p-2 min-h-[80px]">
          <div class="col-span-full text-center text-[10px] text-gray-500 italic" id="noPhotos">Aucune photo.</div>
        </div>
      </section>

      <section class="mb-3">
        <p class="text-[9px] text-justify mb-2">Le client reconna√Æt que les travaux ont √©t√© r√©alis√©s conform√©ment au bon de commande. IMPORTANT : Les produits utilis√©s sont dangereux. Le client s'engage √† respecter les consignes.</p>
        <div class="grid grid-cols-2 gap-4">
          <div class="border p-2">
            <label class="text-[10px] font-bold uppercase block mb-1">Signature Applicateur</label>
            <div class="border-2 border-dashed relative">
              <canvas id="sigApplicator" width="300" height="100" class="w-full h-20 touch-none cursor-crosshair"></canvas>
              <div id="placeholderApp" class="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-400 text-[10px]">Signer ici</div>
            </div>
            <button type="button" onclick="clearSignature('sigApplicator', 'placeholderApp')" class="text-[9px] text-red-600 underline no-print mt-1">Effacer</button>
          </div>
          <div class="border p-2">
            <label class="text-[10px] font-bold uppercase block mb-1">Signature Client</label>
            <div class="border-2 border-dashed relative">
              <canvas id="sigClient" width="300" height="100" class="w-full h-20 touch-none cursor-crosshair"></canvas>
              <div id="placeholderClient" class="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-400 text-[10px]">Signer ici</div>
            </div>
            <button type="button" onclick="clearSignature('sigClient', 'placeholderClient')" class="text-[9px] text-red-600 underline no-print mt-1">Effacer</button>
          </div>
        </div>
      </section>

      <div class="text-center text-[9px] text-gray-500 mt-4 border-t pt-2 no-print">TSF NORMANDIE - Digital Report Mobile v5</div>
      <div class="text-right text-[8px] text-gray-400 hidden print:block mt-2">Membre du r√©seau APROLLIANCE</div>
    </div>
  </div><script>
    let chemicalRows = [];
    let mechanicalRows = [];
    let photos = [];
    let memories = { clients: [], locations: [], products: [] };

    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('time').value = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

    try {
      const saved = localStorage.getItem('tsf_memories');
      if (saved) memories = JSON.parse(saved);
      updateDatalist('list-clients', memories.clients);
      updateDatalist('list-locations', memories.locations);
      updateDatalist('list-products', memories.products);
    } catch(e) {}

    function updateDatalist(id, items) {
      const dl = document.getElementById(id);
      dl.innerHTML = items.map(i => `<option value="${i}"></option>`).join('');
    }

    function saveToMemory() {
      const client = document.getElementById('clientNom').value;
      const location = document.getElementById('locations').value;
      
      if (client && !memories.clients.includes(client)) {
        memories.clients.push(client);
        memories.clients.sort();
      }
      if (location && !memories.locations.includes(location)) {
        memories.locations.push(location);
        memories.locations.sort();
      }
      
      chemicalRows.forEach(r => {
        const prod = r.productName;
        if (prod && !memories.products.includes(prod)) {
          memories.products.push(prod);
          memories.products.sort();
        }
      });

      try {
        localStorage.setItem('tsf_memories', JSON.stringify(memories));
        updateDatalist('list-clients', memories.clients);
        updateDatalist('list-locations', memories.locations);
        updateDatalist('list-products', memories.products);
      } catch(e) {}
    }

    function addChemicalRow() {
      const id = Date.now();
      chemicalRows.push({ id, isToxic: true, productName: '', activeMaterial: '', quantity: '', stationNumber: '' });
      renderChemicalTable();
    }

    function removeChemicalRow(id) {
      chemicalRows = chemicalRows.filter(r => r.id !== id);
      renderChemicalTable();
    }

    function renderChemicalTable() {
      const tbody = document.getElementById('chemicalTable');
      tbody.innerHTML = chemicalRows.map(row => `
        <tr>
          <td class="border p-1">
            <select onchange="updateChemicalRow(${row.id}, 'isToxic', this.value === 'Toxique')" class="w-full text-[10px]">
              <option ${row.isToxic ? 'selected' : ''}>Toxique</option>
              <option ${!row.isToxic ? 'selected' : ''}>Placebo</option>
            </select>
          </td>
          <td class="border p-1"><input list="list-products" class="w-full text-[10px]" value="${row.productName}" oninput="updateChemicalRow(${row.id}, 'productName', this.value)" /></td>
          <td class="border p-1"><input class="w-full text-[10px]" value="${row.activeMaterial}" oninput="updateChemicalRow(${row.id}, 'activeMaterial', this.value)" /></td>
          <td class="border p-1"><input class="w-full text-[10px]" value="${row.quantity}" oninput="updateChemicalRow(${row.id}, 'quantity', this.value)" /></td>
          <td class="border p-1"><input class="w-full text-[10px]" value="${row.stationNumber}" oninput="updateChemicalRow(${row.id}, 'stationNumber', this.value)" /></td>
          <td class="border p-1 text-center no-print"><button onclick="removeChemicalRow(${row.id})" class="text-red-500 font-bold">√ó</button></td>
        </tr>
      `).join('');
    }

    function updateChemicalRow(id, field, value) {
      const row = chemicalRows.find(r => r.id === id);
      if (row) row[field] = value;
    }

    function addMechanicalRow() {
      const id = Date.now();
      mechanicalRows.push({ id, type: 'Tapette', quantity: '', stationNumber: '' });
      renderMechanicalTable();
    }

    function removeMechanicalRow(id) {
      mechanicalRows = mechanicalRows.filter(r => r.id !== id);
      renderMechanicalTable();
    }

    function renderMechanicalTable() {
      const tbody = document.getElementById('mechanicalTable');
      tbody.innerHTML = mechanicalRows.map(row => `
        <tr>
          <td class="border p-1 bg-gray-50 text-center text-[10px]">M√©canique</td>
          <td class="border p-1">
            <select onchange="updateMechanicalRow(${row.id}, 'type', this.value)" class="w-full text-[10px]">
              <option ${row.type === 'Tapette' ? 'selected' : ''}>Tapette</option>
              <option ${row.type === 'Plaque de Glue' ? 'selected' : ''}>Plaque de Glue</option>
              <option ${row.type === 'Autres' ? 'selected' : ''}>Autres</option>
            </select>
          </td>
          <td class="border p-1"><input class="w-full text-[10px]" value="${row.quantity}" oninput="updateMechanicalRow(${row.id}, 'quantity', this.value)" /></td>
          <td class="border p-1"><input class="w-full text-[10px]" value="${row.stationNumber}" oninput="updateMechanicalRow(${row.id}, 'stationNumber', this.value)" /></td>
          <td class="border p-1 text-center no-print"><button onclick="removeMechanicalRow(${row.id})" class="text-red-500 font-bold">√ó</button></td>
        </tr>
      `).join('');
    }

    function updateMechanicalRow(id, field, value) {
      const row = mechanicalRows.find(r => r.id === id);
      if (row) row[field] = value;
    }

    function handlePhotoUpload(e) {
      if (!e.target.files) return;
      Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onloadend = () => {
          photos.push(reader.result);
          renderPhotos();
        };
        reader.readAsDataURL(file);
      });
    }

    function removePhoto(index) {
      photos.splice(index, 1);
      renderPhotos();
    }

    function renderPhotos() {
      const container = document.getElementById('photosContainer');
      const noPhotos = document.getElementById('noPhotos');
      
      if (photos.length === 0) {
        noPhotos.style.display = 'block';
      } else {
        noPhotos.style.display = 'none';
        container.innerHTML = photos.map((photo, i) => `
          <div class="relative border">
            <img src="${photo}" class="w-full h-16 object-cover" />
            <button onclick="removePhoto(${i})" class="absolute top-0 right-0 bg-red-600 text-white w-5 h-5 flex items-center justify-center text-xs no-print">√ó</button>
          </div>
        `).join('') + '<div class="col-span-full text-center text-[10px] text-gray-500 italic hidden" id="noPhotos">Aucune photo.</div>';
      }
    }

    function initSignature(canvasId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';
      let isDrawing = false;

      const getCoords = (e) => {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
      };

      const startDrawing = (e) => {
        e.preventDefault();
        isDrawing = true;
        const placeholder = canvasId === 'sigApplicator' ? 'placeholderApp' : 'placeholderClient';
        document.getElementById(placeholder).style.display = 'none';
        const coords = getCoords(e);
        ctx.beginPath();
        ctx.moveTo(coords.x, coords.y);
      };

      const draw = (e) => {
        if (!isDrawing) return;
        e.preventDefault();
        const coords = getCoords(e);
        ctx.lineTo(coords.x, coords.y);
        ctx.stroke();
      };

      const stopDrawing = () => { isDrawing = false; };

      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseleave', stopDrawing);
      canvas.addEventListener('touchstart', startDrawing);
      canvas.addEventListener('touchmove', draw);
      canvas.addEventListener('touchend', stopDrawing);
    }

    function clearSignature(canvasId, placeholderId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById(placeholderId).style.display = 'flex';
    }

    initSignature('sigApplicator');
    initSignature('sigClient');

    function saveDraft() {
      const data = {
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        applicatorName: document.getElementById('applicatorName').value,
        clientNom: document.getElementById('clientNom').value,
        clientPrenom: document.getElementById('clientPrenom').value,
        clientAdresse: document.getElementById('clientAdresse').value,
        clientCP: document.getElementById('clientCP').value,
        clientVille: document.getElementById('clientVille').value,
        emailBureau: document.getElementById('emailBureau').value,
        emailClient: document.getElementById('emailClient').value,
        nextVisit: document.getElementById('nextVisit').value,
        locations: document.getElementById('locations').value,
        traces: document.querySelector('input[name="traces"]:checked')?.value,
        pressure: document.querySelector('input[name="pressure"]:checked')?.value,
        treatment: document.querySelector('input[name="treatment"]:checked')?.value,
        chemicalRows, mechanicalRows,
        addMiceLieu: document.getElementById('addMiceLieu').value,
        addMiceNonSec: document.getElementById('addMiceNonSec').value,
        addMiceSec: document.getElementById('addMiceSec').value,
        addRatsLieu: document.getElementById('addRatsLieu').value,
        addRatsNonSec: document.getElementById('addRatsNonSec').value,
        addRatsSec: document.getElementById('addRatsSec').value,
        replMiceLieu: document.getElementById('replMiceLieu').value,
        replMiceNonSec: document.getElementById('replMiceNonSec').value,
        replMiceSec: document.getElementById('replMiceSec').value,
        replRatsLieu: document.getElementById('replRatsLieu').value,
        replRatsNonSec: document.getElementById('replRatsNonSec').value,
        replRatsSec: document.getElementById('replRatsSec').value,
        techSheets: document.getElementById('techSheets').checked,
        safetySheets: document.getElementById('safetySheets').checked,
        correctiveActions: document.getElementById('correctiveActions').value,
        previousRecommendations: document.getElementById('previousRecommendations').value,
        sigApplicator: document.getElementById('sigApplicator').toDataURL(),
        sigClient: document.getElementById('sigClient').toDataURL()
      };
      
      try {
        localStorage.setItem('tsf_draft', JSON.stringify(data));
        saveToMemory();
        alert('‚úÖ Brouillon sauvegard√© !');
      } catch(e) { alert('‚ö†Ô∏è Impossible de sauvegarder'); }
    }

    function loadDraft() {
      try {
        const saved = localStorage.getItem('tsf_draft');
        if (!saved) { alert('Aucun brouillon.'); return; }
        if (!confirm('Charger le brouillon ?')) return;
        
        const data = JSON.parse(saved);
        
        document.getElementById('date').value = data.date || '';
        document.getElementById('time').value = data.time || '';
        document.getElementById('applicatorName').value = data.applicatorName || '';
        document.getElementById('clientNom').value = data.clientNom || '';
        document.getElementById('clientPrenom').value = data.clientPrenom || '';
        document.getElementById('clientAdresse').value = data.clientAdresse || '';
        document.getElementById('clientCP').value = data.clientCP || '';
        document.getElementById('clientVille').value = data.clientVille || '';
        document.getElementById('emailBureau').value = data.emailBureau || '';
        document.getElementById('emailClient').value = data.emailClient || '';
        document.getElementById('nextVisit').value = data.nextVisit || '';
        document.getElementById('locations').value = data.locations || '';
        
        if (data.traces) {
          const radio = document.querySelector(`input[name="traces"][value="${data.traces}"]`);
          if (radio) radio.checked = true;
        }
        if (data.pressure) {
          const radio = document.querySelector(`input[name="pressure"][value="${data.pressure}"]`);
          if (radio) radio.checked = true;
        }
        if (data.treatment) {
          const radio = document.querySelector(`input[name="treatment"][value="${data.treatment}"]`);
          if (radio) radio.checked = true;
        }
        
        chemicalRows = data.chemicalRows || [];
        mechanicalRows = data.mechanicalRows || [];
        renderChemicalTable();
        renderMechanicalTable();
        
        document.getElementById('addMiceLieu').value = data.addMiceLieu || '';
        document.getElementById('addMiceNonSec').value = data.addMiceNonSec || '';
        document.getElementById('addMiceSec').value = data.addMiceSec || '';
        document.getElementById('addRatsLieu').value = data.addRatsLieu || '';
        document.getElementById('addRatsNonSec').value = data.addRatsNonSec || '';
        document.getElementById('addRatsSec').value = data.addRatsSec || '';
        document.getElementById('replMiceLieu').value = data.replMiceLieu || '';
        document.getElementById('replMiceNonSec').value = data.replMiceNonSec || '';
        document.getElementById('replMiceSec').value = data.replMiceSec || '';
        document.getElementById('replRatsLieu').value = data.replRatsLieu || '';
        document.getElementById('replRatsNonSec').value = data.replRatsNonSec || '';
        document.getElementById('replRatsSec').value = data.replRatsSec || '';
        
        document.getElementById('techSheets').checked = data.techSheets || false;
        document.getElementById('safetySheets').checked = data.safetySheets || false;
        
        document.getElementById('correctiveActions').value = data.correctiveActions || '';
        document.getElementById('previousRecommendations').value = data.previousRecommendations || '';
        
        if (data.sigApplicator) {
          const canvas = document.getElementById('sigApplicator');
          const ctx = canvas.getContext('2d');
          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, 0, 0);
            document.getElementById('placeholderApp').style.display = 'none';
          };
          img.src = data.sigApplicator;
        }
        
        if (data.sigClient) {
          const canvas = document.getElementById('sigClient');
          const ctx = canvas.getContext('2d');
          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, 0, 0);
            document.getElementById('placeholderClient').style.display = 'none';
          };
          img.src = data.sigClient;
        }
        
        alert('‚úÖ Brouillon charg√© !');
      } catch(e) { alert('‚ùå Erreur'); }
    }

    async function generatePDF() {
      const clientNom = document.getElementById('clientNom').value;
      if (!clientNom) { alert('‚ö†Ô∏è Nom client requis'); return; }

      try {
        saveToMemory();
        
        const element = document.getElementById('report').cloneNode(true);
        
        const sigApp = document.getElementById('sigApplicator').toDataURL();
        const sigCli = document.getElementById('sigClient').toDataURL();
        
        const canvases = element.querySelectorAll('canvas');
        if (canvases[0]) canvases[0].outerHTML = `<img src="${sigApp}" style="width:100%; height:auto;"/>`;
        if (canvases[1]) canvases[1].outerHTML = `<img src="${sigCli}" style="width:100%; height:auto;"/>`;

        const date = document.getElementById('date').value.split('-').reverse().join('-');
        const filename = `TSF_${clientNom.replace(/[^a-zA-Z0-9]/g, '_')}_${date}.pdf`;

        await html2pdf().set({
          margin: [5, 5, 5, 5],
          filename,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 3, useCORS: true, logging: false },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true }
        }).from(element).save();

        alert('‚úÖ PDF t√©l√©charg√© : ' + filename);
      } catch (error) {
        console.error(error);
        alert('‚ùå Erreur PDF');
      }
    }

    function resetForm() {
      if (!confirm('R√©initialiser le formulaire ?')) return;
      
      document.getElementById('date').valueAsDate = new Date();
      document.getElementById('time').value = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      document.getElementById('applicatorName').value = '';
      document.getElementById('clientNom').value = '';
      document.getElementById('clientPrenom').value = '';
      document.getElementById('clientAdresse').value = '';
      document.getElementById('clientCP').value = '';
      document.getElementById('clientVille').value = '';
      document.getElementById('emailBureau').value = '';
      document.getElementById('emailClient').value = '';
      document.getElementById('nextVisit').value = '';
      document.getElementById('locations').value = '';
      document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
      document.querySelector('input[name="treatment"][value="conventional"]').checked = true;
      chemicalRows = [];
      mechanicalRows = [];
      renderChemicalTable();
      renderMechanicalTable();
      document.getElementById('addMiceLieu').value = '';
      document.getElementById('addMiceNonSec').value = '';
      document.getElementById('addMiceSec').value = '';
      document.getElementById('addRatsLieu').value = '';
      document.getElementById('addRatsNonSec').value = '';
      document.getElementById('addRatsSec').value = '';
      document.getElementById('replMiceLieu').value = '';
      document.getElementById('replMiceNonSec').value = '';
      document.getElementById('replMiceSec').value = '';
      document.getElementById('replRatsLieu').value = '';
      document.getElementById('replRatsNonSec').value = '';
      document.getElementById('replRatsSec').value = '';
      document.getElementById('techSheets').checked = false;
      document.getElementById('safetySheets').checked = false;
      document.getElementById('correctiveActions').value = '';
      document.getElementById('previousRecommendations').value = '';
      photos = [];
      renderPhotos();
      clearSignature('sigApplicator', 'placeholderApp');
      clearSignature('sigClient', 'placeholderClient');
      
      alert('‚úÖ Formulaire r√©initialis√© !');
    }
  </script>
</body>
</html>
